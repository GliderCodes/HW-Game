<!DOCTYPE html>
<html lang="zxx">


<head>
	<title>Pixel Wars by Dop4Squ4d</title>

	<!-- Some data that that are not displayed on screen, but are machine parsable. -->
	<meta charset="UTF-8">
	<meta name="description" content="Cloud 83 - hosting template ">
	<meta name="keywords" content="cloud, hosting, creative, html">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Favicon -->
	<link href="img/favicon.ico" rel="shortcut icon" />

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,500,500i,600,600i,700,700i"
		rel="stylesheet">


	<!-- Stylesheets -->
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<link rel="stylesheet" href="css/font-awesome.min.css" />
	<link rel="stylesheet" href="css/flaticon.css" />
	<link rel="stylesheet" href="css/owl.carousel.min.css" />
	<link rel="stylesheet" href="css/animate.css" />
	<link rel="stylesheet" href="css/style.css" />

	<!-- Some scripts -->
	<script src="js/socket.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function () {
			// Handler for .ready() called.
			$('html, body').animate({
				scrollTop: $('#canvas').offset().top
			}, 'slow');
		});
	</script>

</head>

<body>
	<!-- Page Preloder -->

	<!-- Header section -->
	<header class="header-section">
		<a href="./index.html" class="site-logo">Dop3Squ4d</a>
		<div class="nav-switch">
			<i class="fa fa-bars"></i>
		</div>
		<div class="nav-warp">
			<div class="user-panel">
				<a id="user-panel" href="./login.html">Login</a> /
				<a id="user-panel2" href="./login.html">Register</a>
			</div>
			<ul class="main-menu">
				<li><a href="#">Home</a></li>
			</ul>
		</div>
	</header>
	<!-- Header section end -->


	<!-- Hero section -->
	<section class="hero-section set-bg" data-setbg="img/bg.jpg">
		<div class="container h-100">
			<div class="hero-content text-white">
				<div class="row">
					<div class="col-lg-6 pr-0">
						<span id="user.name" style="display: none">{{name}}</span>
						<h2>Pixel Wars</h2>
						<p>An adventure game where you fight each other to until you get the throne, completely
							unfinished but hey!</p>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- Hero section end -->


	<!-- Canvas section start -->
	<div id="canvas-wrap">
		<canvas id="canvas" width="800" height="600" style="border:1px solid #000000;"></canvas>
		<canvas id="ctx-ui" width="800" height="600"></canvas>
		<div id="overlay"></div>
	</div>
	<script src="js/client.js"></script>
	<!-- Canvas section end -->


	<!-- Features section -->
	<section class="features-section spad">
		<div class="container">
			<div class="section-title">
				<img src="./img/section-title-icon.png" alt="#">
				<p>The best out there</p>
				<h2>See our features</h2>
			</div>
			<div class="row">
				<div class="col-lg-4 col-md-6 feature-item">
					<div class="ft-icon">
						<i class="flaticon-map"></i>
					</div>
					<h4>Be able to move your character</h4>
					<p>Use WASD keys or use the arrow keys to control your player. Using the mouse to click
						will do other interactions like shooting or enabling certain events.
					</p>
				</div>
				<div class="col-lg-4 col-md-6 feature-item fi-center-top">
					<div class="ft-icon">
						<i class="flaticon-shield"></i>
					</div>
					<h4>Multiplayer PVP</h4>
					<p>Fight other players and see who is the better one can killing and winning the throne! </p>
				</div>
				<div class="col-lg-4 col-md-6 feature-item">
					<div class="ft-icon">
						<i class="flaticon-coding"></i>
					</div>
					<h4>Only the beginning!</h4>
					<p>It's a brand new game and we have a LOT LOT more to add, stay tuned!!! </p>
				</div>
			</div>
		</div>
	</section>
	<!-- Features section end -->



	<!-- Footer section -->
	<footer class="footer-section">
		<div class="container">
			<ul class="footer-menu">
				<li><a href="">Home</a></li>
			</ul>
			<div class="copyright">
				<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
				This game is made with <i class="fa fa-heart-o" aria-hidden="true"></i> by the Dop3Sq4d.
				<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
			</div>
		</div>
	</footer>
	<!-- Footer top section end -->


	<!--====== Javascripts & Jquery ======-->

	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<script src="js/circle-progress.min.js"></script>
	<script src="js/main.js"></script>
	<script src="js/client.js"></script>
	<script src="js/Entities.js"></script>


	<script>
		// socket connect established
		var socket = io();
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		var ctxUi = document.getElementById("ctx-ui").getContext("2d");
		ctxUi.font = '30px Arial';

		var TILE_SIZE = 32;
		var WIDTH = 640;
		var HEIGHT = 360;
		var CANVAS_WIDTH = 640;
		var CANVAS_HEIGHT = 360;
		var timeWhenGameStarted = Date.now(); //return time in ms


		var frameCount = 0;

		var score = 0;

		var paused = false;

		var Img = {};
		Img.player = new Image();
		Img.player.src = "./img/game/player.png";
		Img.bat = new Image();
		Img.bat.src = './img/game/bat.png';
		Img.bee = new Image();
		Img.bee.src = './img/game/bee.png';
		Img.bullet = new Image();
		Img.bullet.src = './img/game/bullet.png';
		Img.upgrade1 = new Image();
		Img.upgrade1.src = './img/game/upgrade1.png';
		Img.upgrade2 = new Image();
		Img.upgrade2.src = './img/game/upgrade2.png';
		Img.map = new Image();
		Img.map.src = './img/game/map.png';


		var Player = function (initPack) {
			var self = {};
			self.id = initPack.id;
			self.number = initPack.number;
			self.x = initPack.x;
			self.y = initPack.y;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.score = initPack.score;
			self.map = initPack.map;

			self.draw = function () {
				if (Player.list[selfId].map !== self.map)
					return;
				var x = self.x - Player.list[selfId].x + WIDTH / 2;
				var y = self.y - Player.list[selfId].y + HEIGHT / 2;

				var hpWidth = 30 * self.hp / self.hpMax;
				ctx.fillStyle = 'red';
				ctx.fillRect(x - hpWidth / 2, y - 40, hpWidth, 4);

				var width = Img.player.width * 2;
				var height = Img.player.height * 2;


				ctx.drawImage(Img.player,
					0, 0, Img.player.width, Img.player.height,
					x - width / 2, y - height / 2, width, height);

				//ctx.fillText(self.score,self.x,self.y-60);
			}

			Player.list[self.id] = self;


			return self;
		}
		Player.list = {};


		var Bullet = function (initPack) {
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.map = initPack.map;

			self.draw = function () {
				if (Player.list[selfId].map !== self.map)
					return;
				var width = Img.bullet.width / 2;
				var height = Img.bullet.height / 2;

				var x = self.x - Player.list[selfId].x + WIDTH / 2;
				var y = self.y - Player.list[selfId].y + HEIGHT / 2;

				ctx.drawImage(Img.bullet,
					0, 0, Img.bullet.width, Img.bullet.height,
					x - width / 2, y - height / 2, width, height);
			}

			Bullet.list[self.id] = self;
			return self;
		}
		Bullet.list = {};

		var selfId = null;

		socket.on('init', function (data) {
			if (data.selfId)
				selfId = data.selfId;
			//{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], bullet: []}
			for (var i = 0; i < data.player.length; i++) {
				new Player(data.player[i]);
			}
			for (var i = 0; i < data.bullet.length; i++) {
				new Bullet(data.bullet[i]);
			}
		});

		socket.on('update', function (data) {
			//{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], bullet: []}
			for (var i = 0; i < data.player.length; i++) {
				var pack = data.player[i];
				var p = Player.list[pack.id];
				if (p) {
					if (pack.x !== undefined)
						p.x = pack.x;
					if (pack.y !== undefined)
						p.y = pack.y;
					if (pack.hp !== undefined)
						p.hp = pack.hp;
					if (pack.score !== undefined)
						p.score = pack.score;
					if (pack.map !== undefined)
						p.map = pack.map;
				}
			}
			for (var i = 0; i < data.bullet.length; i++) {
				var pack = data.bullet[i];
				var b = Bullet.list[data.bullet[i].id];
				if (b) {
					if (pack.x !== undefined)
						b.x = pack.x;
					if (pack.y !== undefined)
						b.y = pack.y;
				}
			}
		});

		socket.on('remove', function (data) {
			//{player:[12323],bullet:[12323,123123]}
			for (var i = 0; i < data.player.length; i++) {
				delete Player.list[data.player[i]];
			}
			for (var i = 0; i < data.bullet.length; i++) {
				delete Bullet.list[data.bullet[i]];
			}
		});

		setInterval(function () {
			if (!selfId)
				return;
			ctx.clearRect(0, 0, 500, 500);
			drawMap();
			drawScore();
			for (var i in Player.list)
				Player.list[i].draw();
			for (var i in Bullet.list)
				Bullet.list[i].draw();
		}, 40);

		var drawMap = function () {
			var player = Player.list[selfId];
			var x = WIDTH / 2 - player.x;
			var y = HEIGHT / 2 - player.y;
			console.log("hello")
			ctx.drawImage(Img.map, x, y);
		}

		var drawScore = function () {
			if (lastScore === Player.list[selfId].score)
				return;
			lastScore = Player.list[selfId].score;
			ctxUi.clearRect(0, 0, 500, 500);
			ctxUi.fillStyle = 'white';
			ctxUi.fillText(Player.list[selfId].score, 0, 30);
		}
		var lastScore = null;

		document.onkeydown = function (event) {
			if (event.keyCode === 68) //d
				socket.emit('keyPress', {
					inputId: 'right',
					state: true
				});
			else if (event.keyCode === 83) //s
				socket.emit('keyPress', {
					inputId: 'down',
					state: true
				});
			else if (event.keyCode === 65) //a
				socket.emit('keyPress', {
					inputId: 'left',
					state: true
				});
			else if (event.keyCode === 87) // w
				socket.emit('keyPress', {
					inputId: 'up',
					state: true
				});

		}
		document.onkeyup = function (event) {
			if (event.keyCode === 68) //d
				socket.emit('keyPress', {
					inputId: 'right',
					state: false
				});
			else if (event.keyCode === 83) //s
				socket.emit('keyPress', {
					inputId: 'down',
					state: false
				});
			else if (event.keyCode === 65) //a
				socket.emit('keyPress', {
					inputId: 'left',
					state: false
				});
			else if (event.keyCode === 87) // w
				socket.emit('keyPress', {
					inputId: 'up',
					state: false
				});
		}

		document.onmousedown = function (event) {
			socket.emit('keyPress', {
				inputId: 'attack',
				state: true
			});
		}
		document.onmouseup = function (event) {
			socket.emit('keyPress', {
				inputId: 'attack',
				state: false
			});
		}
		document.onmousemove = function (event) {
			var x = -250 + event.clientX - 8;
			var y = -250 + event.clientY - 8;
			var angle = Math.atan2(y, x) / Math.PI * 180;
			socket.emit('keyPress', {
				inputId: 'mouseAngle',
				state: angle
			});
		}

		document.oncontextmenu = function (event) {
			event.preventDefault();
		}
	</script>

</body>

</html>
